from micropython import const
from machine import Pin, SoftSPI, SoftI2C
from utime import sleep_ms
from BME280_SPI import BME280_SPI
from SSD1306_SPI import OLED1306
import framebuf


background = framebuf.FrameBuffer(bytearray(
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3f\x29'
    b'\x2e\x18\x00\x3f\x06\x38\x38\x06\x3f\x00\x00\x3f\x21\x21\x20\x31\x2b\x26\x00\x10\x3f\x2d\x3e\x00\x1c\x37\x21\x3e\x00\x00\x00\x00'
    b'\x08\x00\x00\x00\x00\x3f\x09\x1e\x26\x00\x3f\x09\x0e\x06\x20\x31\x29\x26\x00\x1c\x37\x21\x3e\x00\x18\x14\x13\x3e\x00\x1c\x37\x21'
    b'\x3e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfe\x03\x01\x01\x03\xfe\x00\xaa\xaa\xaa\x22\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x60\x10\x08\x04\x04\x18\x30'
    b'\x40\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x80\xff\xff\x01\xff\x80'
    b'\x80\x00\x80\x80\xff\xff\x01\xff\x80\x80\x00\x00\x00\x80\x80\x80\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x00\xf8\xf8\x00\xff\x00\xaa\xaa\xaa\x22\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x30\x04\x03\x00\x80\x40\x80\x00\x00\x80\x00'
    b'\x00\x01\x03\x0c\x30\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x60\x60\x61\x43\x07\x4c\x4c\x47\x63'
    b'\x61\x40\x41\x43\x47\x4c\x48\x45\x43\x61\x40\x4c\x4f\x61\x60\x60\x61\x33\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf0\x4c\xf7\xf8\xff\xff\xf8\xf7\xc8\xf2\x02\x02\x02\x80\x00\x00\x00\x80\x80'
    b'\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3e\xc1\x00\x00\x00\x00\x03\x00\x22\x08\x02\x38\x04'
    b'\x38\x00\x00\x00\x00\xc1\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x09\x09\x09\x09\x09\x09\x08\x01\x09'
    b'\x08\x00\x09\x09\x09\x09\x09\x09\x09\x01\x01\x09\x09\x01\x01\x01\x01\x01\x01\x01\x19\x79\x41\xc1\x81\xc3\x66\x3c\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x06\x0d\x0b\x0b\x0b\x0b\x0d\x06\x03\x00\x00\x00\x00\x01\x00\x02\x0f\x08'
    b'\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x04\x04\x08\x08\x10\x10\x10\x10\x10\x08'
    b'\x08\x08\x04\x02\x01\x00\x00\x00\x02\x12\x09\x06\x15\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1e\x02\x1c'
    b'\x02\x1e\x00\x00\x1f\x12\x1c\x08\x1a\x1a\x14\x00\x0e\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'),
    128, 64, framebuf.MONO_VLSB)


spi1 = SoftSPI(baudrate=100000, polarity = 0, phase = 0,  sck = Pin(12), mosi = Pin(11), miso = Pin(8))
bme = BME280_SPI(spi1, 10)

spi2 = SoftSPI(baudrate=100000, polarity = 0, phase = 0,  sck = Pin(27), mosi = Pin(18), miso = Pin(25))
oled = OLED1306(spi2, 28, 14, 22)

while(True):
    oled.blit(background, 0, 0)
    oled.text(str("%2.1f" %bme.get_T()), 1, 56, oled.WHITE)
    oled.text(str("%2.1f" %bme.get_RH()), 46, 56, oled.WHITE)
    oled.text(str("%4.0f" %bme.get_P()), 86, 56, oled.WHITE)
    print(bme.get_T())
    print(bme.get_P())
    print(bme.get_RH())
    oled.show()
    sleep_ms(400) 