from machine import Pin, I2C
from utime import sleep_ms
from onewire import OneWire
from ds18x20 import DS18X20
from SSD1306_I2C import OLED1306
import framebuf 


LED = Pin(25, Pin.OUT)
i2c = I2C(1, sda = Pin(2), scl = Pin(3), freq = 100000)
oled = OLED1306(i2c)
ow = OneWire(Pin(14)) 
ds = DS18X20(ow)


ow.scan()
roms = ds.scan()


background = framebuf.FrameBuffer(bytearray(
    b'\x00\x00\x00\x00\x00\x00\xfe\x01\x01\x01\xfe\x00\x00\x00\x84\x84\x04\x04\x00\x00\x17\x15\x1d\x00\x1f\x11\x1f\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfc\x04\x04\x04\x88\x20\x80'
    b'\x1c\x24\x24\x80\x00\x08\x04\xfc\x00\x00\x00\x5c\x24\x24\xdc\x00\x00\xfc\x24\x24\x78\x80\x00\x84\x84\x64\x18\x00\x20\x88\x04\x04'
    b'\x8c\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\x10\x10\x10\x10\x00\x00\x1c\x10\x7c\x00\x7c\x44\x7c\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x01\x01\x01\x00\x00\x00'
    b'\x01\x01\x01\x00\x00\x01\x01\x01\x01\x00\x00\x01\x01\x01\x01\x00\x00\x01\x01\x01\x01\x00\x00\x81\x01\x01\x01\x00\x00\x01\x01\x01'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\x42\x42\x40\x40\x00\x00\x10\x50\xf0\x00\xf0\x10\xf0\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x01\x7f\x01\x01\x00'
    b'\x78\x54\x54\x5c\x00\x00\x7c\x04\x04\x7c\x04\x04\x7c\x00\x00\xfc\x44\x44\x6c\x10\x00\x60\x0c\x01\x00\x05\x05\x00\x00\x3e\x41\x41'
    b'\x41\x22\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\x08\x08\x00\x00\x00\x00\x41\x41\xc1\x00\xc1\x41\xc1\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\x21\x21\x01\x01\x00\x00\x07\x05\x05\x00\x07\x04\x07\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\x84\x84\x04\x04\x00\x00\x00\x1f\x00\x00\x1f\x11\x1f\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x80\x40\x7f\x80\xe0\x80\x3f\x40\x80\x00\x10\x10\x10\x10\x00\x00\x7c\x44\x7c\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x1f\x20\x4e\x9f\xbf\xbf\xbf\x9f\x4e\x20\x1f\x00\x00\x00\x00\x00\x00\x1c\x14\x1c\x00\x00\x7c\x44\x44\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'),
    128, 64, framebuf.MONO_VLSB)



def map_value(v, x_min, x_max, y_min, y_max):
    return int(y_min + (((y_max - y_min)/(x_max - x_min)) * (v - x_min)))


while True:
    ds.convert_temp()
    LED.toggle()
    sleep_ms(750)
    t = ds.read_temp(roms[0])
    
    bar = map_value(t, 0, 50,  52, 2)

    oled.blit(background, 0, 0)
    oled.line(8, 52, 8, bar, oled.WHITE)
    oled.text(str("%2.2f" % t), 56, 35, oled.WHITE)
    
    oled.show()